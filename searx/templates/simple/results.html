{% extends "simple/base.html" %}
{% from 'simple/icons.html' import icon, icon_big, icon_small %}
{% macro engine_data_form(engine_data) -%}
    {% for engine_name, kv_data in engine_data.items() %}
        {% for k, v in kv_data.items() %}
            <input type="hidden" name="engine_data-{{ engine_name }}-{{ k|e }}" value="{{ v|e }}">
        {% endfor %}
    {% endfor %}
{%- endmacro %}
{% block title %}{% if query_in_title %}{{- q|e }} - {% endif %}{% endblock %}
{% block meta %}<link rel="alternate" type="application/rss+xml" title="Searx search: {{ q|e }}" href="{{ url_for('search', _external=True) }}?q={{ q|urlencode }}&amp;categories={{ selected_categories|join(",") | replace(' ','+') }}&amp;pageno={{ pageno }}&amp;time_range={{ time_range }}&amp;language={{ current_language }}&amp;safesearch={{ safesearch }}&amp;format=rss">{% endblock %}
{% block content %}
{% include 'simple/search.html' %}

{% if results and results|map(attribute='template')|unique|list|count == 1 %}
  {% set only_template = 'only_template_' + results[0]['template']|default('default')|replace('.html', '') %}
{% else %}
  {% set only_template = '' %}
{% endif %}

<div id="results" class="{{ only_template }}">

  {%- if answers -%}
    {%- include 'simple/elements/answers.html' -%}
  {%- endif %}

    <div id="sidebar">

        {%- if number_of_results != '0' -%}
        <p id="result_count"><small>{{ _('Number of results') }}: {{ number_of_results }}</small></p>
        {%- endif -%}

        {%- if infoboxes -%}
          <div id="infoboxes">
            <details open class="sidebar-collapsible">
              <summary class="title">{{ _('Info') }}</summary>
              {%- for infobox in infoboxes -%}
                {%- include 'simple/elements/infobox.html' -%}
              {%- endfor -%}
            </details>
          </div>
        {%- endif -%}

        <div id="ai-summary-sidebar" data-config='{{ ai_config | tojson }}'>
          <details id="ai-summary-toggle" class="sidebar-collapsible" open>
            <summary class="title">
              <span id="ai-summary-title">{{ _('AI Summary') }}</span>
              <span id="ai-summary-status"></span>
            </summary>
            <div id="ai-summary-content" class="ai-summary-body">
            </div>
          </details>
          <details id="ai-stats-toggle" class="sidebar-collapsible">
            <summary class="title">{{ _('AI Stats') }}</summary>
            <div id="ai-stats-content" class="ai-stats-body">
              <table class="ai-stats-table">
                <tbody>
                  <tr><td>{{ _('Model') }}</td><td id="ai-stat-model">-</td></tr>
                  <tr><td>{{ _('Prompt Tokens') }}</td><td id="ai-stat-prompt">-</td></tr>
                  <tr><td>{{ _('Completion Tokens') }}</td><td id="ai-stat-completion">-</td></tr>
                  <tr><td>{{ _('Total Tokens') }}</td><td id="ai-stat-total">-</td></tr>
                  <tr><td>{{ _('Response Time') }}</td><td id="ai-stat-time">-</td></tr>
                  <tr><td>{{ _('Tokens/sec') }}</td><td id="ai-stat-tps">-</td></tr>
                </tbody>
              </table>
            </div>
          </details>
        </div>

        {%- if suggestions -%}
          {%- include 'simple/elements/suggestions.html' -%}
        {%- endif -%}

        {%- include 'simple/elements/engines_msg.html' -%}

        {%- if method == 'POST' -%}
          {%- include 'simple/elements/search_url.html' -%}
        {%- endif -%}

        {%- if search_formats -%}
          {%- include 'simple/elements/apis.html' -%}
        {%- endif -%}

        <div id="sidebar-end-collapsible"></div>
    </div>

    {%- if corrections -%}
      {%- include 'simple/elements/corrections.html' -%}
    {%- endif -%}

    <div id="urls" role="main">
    {% for result in results %}
        {% if result.open_group and not only_template %}<div class="template_group_{{ result['template']|replace('.html', '') }}">{% endif %}
        {% set index = loop.index %}
        {% include get_result_template('simple', result['template']) %}
        {% if result.close_group and not only_template %}</div>{% endif %}
    {% endfor %}
    {% if not results and not answers %}
        {% include 'simple/messages/no_results.html' %}
    {% endif %}
    </div>
    <div id="backToTop">
      <a href="#" aria-label="{{ _('Back to top') }}">{{ icon_small('navigate-up') }}</a>
    </div>
    {% if paging %}
    <nav id="pagination" role="navigation">
        {% if pageno > 1 %}
            <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}" class="previous_page">
                <div class="{% if rtl %}right{% else %}left{% endif %}">
                  <input type="hidden" name="q" value="{{ q|e }}" >
                  {% for category in selected_categories %}
                  <input type="hidden" name="category_{{ category }}" value="1" >
                  {% endfor %}
                  <input type="hidden" name="pageno" value="{{ pageno-1 }}" >
                  <input type="hidden" name="language" value="{{ current_language }}" >
                  <input type="hidden" name="time_range" value="{{ time_range }}" >
                  <input type="hidden" name="safesearch" value="{{ safesearch }}" >
                  <input type="hidden" name="theme" value="{{ theme }}" >
                  {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
                  {{- engine_data_form(engine_data) -}}
                  <button role="link" type="submit">{{ icon_small('navigate-left') }} {{ _('Previous page') }}</button>
                </div>
            </form>
        {% endif %}
        {%- if results | count > 0 -%}
          <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}" class="next_page">
              <div class="{% if rtl %}left{% else %}right{% endif %}">
                <input type="hidden" name="q" value="{{ q|e }}" >
                {% for category in selected_categories %}
                <input type="hidden" name="category_{{ category }}" value="1" >
                {% endfor %}
                <input type="hidden" name="pageno" value="{{ pageno+1 }}" >
                <input type="hidden" name="language" value="{{ current_language }}" >
                <input type="hidden" name="time_range" value="{{ time_range }}" >
                <input type="hidden" name="safesearch" value="{{ safesearch }}" >
                <input type="hidden" name="theme" value="{{ theme }}" >
                {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
                {{- engine_data_form(engine_data) -}}
                <button role="link"  type="submit">{{ _('Next page') }} {{ icon_small('navigate-right') }}</button>
              </div>
          </form>
        {%- endif -%}
        {% set pstart = 1 %}
        {% set pend = 11 %}
        {% if pageno > 5 %}
            {% set pstart = pageno - 4 %}
            {% set pend = pageno + 6 %}
        {% endif %}

        <div class="numbered_pagination">
        {% for x in range(pstart, pend) %}
            <form method="{{ method or 'POST' }}" action="{{ url_for('search') }}" class="page_number">
                <input type="hidden" name="q" value="{{ q|e }}" >
                {% for category in selected_categories %}
                <input type="hidden" name="category_{{ category }}" value="1" >
                {% endfor %}
                <input type="hidden" name="pageno" value="{{ x }}" >
                <input type="hidden" name="language" value="{{ current_language }}" >
                <input type="hidden" name="time_range" value="{{ time_range }}" >
                <input type="hidden" name="safesearch" value="{{ safesearch }}" >
                <input type="hidden" name="theme" value="{{ theme }}" >
                {% if timeout_limit %}<input type="hidden" name="timeout_limit" value="{{ timeout_limit|e }}" >{% endif %}
                {{- engine_data_form(engine_data) -}}
                {% if pageno == x %}
                <input role="link" class="page_number_current" type="button" value="{{ x }}">
                {% else %}
                <input role="link" class="page_number" type="submit" value="{{ x }}">
                {% endif %}
            </form>
        {% endfor %}
        </div>
    </nav>
    {% endif %}
 </div>

{%- if ai_config.endpoint and ai_config.model -%}
<script>
(function() {
  var sidebarEl = document.getElementById('ai-summary-sidebar');
  if (!sidebarEl) return;

  var toggle = document.getElementById('ai-summary-toggle');
  var content = document.getElementById('ai-summary-content');
  var status = document.getElementById('ai-summary-status');

  var aiConfig = {};
  try {
    aiConfig = JSON.parse(sidebarEl.dataset.config || '{}');
    console.log('AI Config:', aiConfig);
  } catch (e) {
    console.error('Failed to parse AI config:', e);
    return;
  }

  if (!aiConfig.endpoint || !aiConfig.model) {
    console.log('AI config missing - endpoint:', aiConfig.endpoint, 'model:', aiConfig.model);
    content.innerHTML = '<p class="ai-summary-placeholder">{{ _("AI summary is not configured. Set up API endpoint and model in preferences.") }}</p>';
    return;
  }

  console.log('AI config looks good, checking toggle state...');
  console.log('toggle.open:', toggle.open);
  console.log('content.dataset.generated:', content.dataset.generated);

  toggle.addEventListener('toggle', function(e) {
    console.log('Toggle event, open:', toggle.open);
    if (toggle.open && !content.dataset.generated) {
      generateSummary();
    }
  });

  if (toggle.open && !content.dataset.generated) {
    console.log('Calling generateSummary directly...');
    generateSummary();
  }

  function generateSummary() {
    console.log('Generating summary with config:', aiConfig);
    content.innerHTML = '<p class="ai-summary-loading">{{ _("Generating summary...") }}</p>';
    status.innerHTML = '<span class="loading-spinner"></span>';

    var searchResults = [];
    var resultsContainer = document.querySelectorAll('#urls .result');
    console.log('Found results:', resultsContainer.length);
    
    resultsContainer.forEach(function(result, index) {
      if (aiConfig.num_results && index >= aiConfig.num_results) return;

      var titleEl = result.querySelector('h3 a');
      var contentEl = result.querySelector('.content');
      var urlEl = result.querySelector('.url_wrapper');

      searchResults.push({
        title: titleEl ? titleEl.textContent : '',
        content: contentEl ? contentEl.textContent : '',
        url: urlEl ? urlEl.textContent : ''
      });
    });
    
    console.log('Search results to summarize:', searchResults);

    fetch('{{ url_for('generate_summary') }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        query: document.querySelector('input[name="q"]').value,
        results: searchResults.slice(0, aiConfig.num_results)
      })
    })
    .then(function(response) { return response.json(); })
    .then(function(data) {
      if (data.success) {
        content.innerHTML = '<div class="ai-summary-text">' + convertMarkdown(data.summary) + '</div>';
        content.dataset.generated = 'true';
        status.innerHTML = '';

        if (data.stats) {
          document.getElementById('ai-stat-model').textContent = data.stats.model || '-';
          document.getElementById('ai-stat-prompt').textContent = data.stats.prompt_tokens || '0';
          document.getElementById('ai-stat-completion').textContent = data.stats.completion_tokens || '0';
          document.getElementById('ai-stat-total').textContent = data.stats.total_tokens || '0';
          document.getElementById('ai-stat-time').textContent = data.stats.response_time ? data.stats.response_time + 's' : '-';
          var tps = (data.stats.response_time && data.stats.total_tokens) 
            ? (data.stats.total_tokens / data.stats.response_time).toFixed(2) 
            : '-';
          document.getElementById('ai-stat-tps').textContent = tps;
        }
      } else {
        content.innerHTML = '<p class="ai-summary-error">{{ _("Error: ") }}' + (data.error || 'Unknown error') + '</p>';
        status.innerHTML = '';
      }
    })
    .catch(function(err) {
      content.innerHTML = '<p class="ai-summary-error">{{ _("Failed to generate summary") }}</p>';
      status.innerHTML = '';
    });
  }

  function convertMarkdown(html) {
    html = html.replace(/<tex>[\s\S]*?<\/tex>/gi, '');
    html = html.replace(/<reply>[\s\S]*?<\/reply>/gi, '');
    html = html.replace(/<thinking>[\s\S]*?<\/thinking>/gi, '');
    html = html.replace(/<tool_code>[\s\S]*?<\/tool_code>/gi, '');
    html = html.trim();
    
    // Convert triple backticks to code blocks
    html = html.replace(/```bash\n([\s\S]*?)```/g, '___PRE_CODE_START___$1___PRE_CODE_END___');
    html = html.replace(/```\n([\s\S]*?)```/g, '___PRE_CODE_START___$1___PRE_CODE_END___');
    html = html.replace(/```(\w+)\n([\s\S]*?)```/g, '___PRE_CODE_START___$2___PRE_CODE_END___');
    
    // Convert single backticks to inline code
    html = html.replace(/`([^`]+)`/g, '___CODE_START___$1___CODE_END___');
    
    // Now escape HTML
    html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Restore code tags
    html = html.replace(/___PRE_CODE_START___/g, '<pre><code>');
    html = html.replace(/___PRE_CODE_END___/g, '</code></pre>');
    html = html.replace(/___CODE_START___/g, '<code>');
    html = html.replace(/___CODE_END___/g, '</code>');
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
    html = html.replace(/_(.+?)_/g, '<em>$1</em>');
    html = html.replace(/^(\d+)\.\s+(.*)$/gm, '<li>$2</li>');
    html = html.replace(/^[\-\*]\s+(.*)$/gm, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
      return '<ul>' + match + '</ul>';
    });
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    if (!html.startsWith('<')) {
      html = '<p>' + html + '</p>';
    }
    return html;
  }
})();
</script>
{%- endif -%}

{% endblock %}
